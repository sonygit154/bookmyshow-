<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookMyShow — Demo (Single File)</title>
<style>
  :root{
    --accent:#ff3b3f; --muted:#98a0b3; --bg:#061428; --card:#071724; --glass: rgba(255,255,255,0.03);
    --radius:12px; --max-width:1100px; --text:#E6F0FA;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#02131d);color:var(--text);-webkit-font-smoothing:antialiased}
  .app{max-width:var(--max-width);margin:22px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{display:flex;align-items:center;gap:12px}
  .mark{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#ff6b6b,#ff3b3f);display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
  .search{flex:1;max-width:560px;margin:0 12px;display:flex;gap:8px;background:var(--glass);padding:8px;border-radius:999px}
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);padding:6px}
  .pill{background:linear-gradient(90deg,#07122988,rgba(255,255,255,0.02));padding:8px 12px;border-radius:999px;font-size:14px;color:var(--muted)}
  nav.tabs{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
  nav.tabs button{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer}
  nav.tabs button.active{background:linear-gradient(90deg, rgba(255,59,63,0.12), rgba(255,91,94,0.04));color:var(--accent);border-color:rgba(255,59,63,0.12)}
  .top-row{display:flex;gap:12px;align-items:flex-start;margin-top:18px}
  .left{flex:1}
  .right{width:320px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
  .chip.active{background:rgba(255,59,63,0.08);color:var(--accent);border-color:rgba(255,59,63,0.12)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:14px}
  .card-item{border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;background:linear-gradient(180deg,#071022,#05111a)}
  .thumb{height:180px;background-size:cover;background-position:center}
  .item-body{padding:10px;flex:1}
  .title{font-weight:700;margin-bottom:6px}
  .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .desc{color:var(--muted);font-size:13px;margin-bottom:8px}
  .card-footer{display:flex;align-items:center;justify-content:space-between;padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
  .btn{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
s;
    
  /* right column specifics */
  aside .offers{display:flex;flex-direction:column;gap:8px}
  .offer{padding:10px;border-radius:8px;background:linear-gradient(90deg,#061022,#0a1624);border:1px dashed rgba(255,255,255,0.02);font-size:14px;color:var(--text)}

  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{width:100%;max-width:720px;background:linear-gradient(180deg,#061425,#061a2a);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .modal h3{margin:0 0 8px}
  .times{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .time{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
  .time.selected{background:rgba(255,59,63,0.12);color:var(--accent);border-color:rgba(255,59,63,0.12)}
  .form-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  input[type="text"],input[type="email"],input[type="password"],input[type="number"],select{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);outline:none}
  label{font-size:13px;color:var(--muted)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#04232f;padding:10px 14px;border-radius:10px;color:white;z-index:80}
 
  /* responsive */
  @media (max-width:900px){
    .right{display:none}
    header{flex-direction:column;align-items:stretch;gap:12px}
    .search{max-width:100%}
    .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="mark">B</div>
      <div>
        <div style="font-weight:700;font-size:18px">BookMyShow</div>
      </div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="Search movies, events, venues..." />
      <button class="btn ghost" id="searchBtn">Search</button>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div class="pill" id="cityPill">City: <strong id="cityName">Select</strong></div>
      <div id="authArea">
        <button class="btn ghost" id="loginBtn">Login</button>
        <button class="btn" id="signupBtn">Sign up</button>
      </div>
    </div>
  </header>

  <nav class="tabs" id="categoryTabs"></nav>

  <div class="top-row">
    <div class="left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:18px;font-weight:700" id="heroTitle">Featured</div>
            <div class="small" id="heroSub">Browse shows, events and cinemas</div>
          </div>
          <div>
            <button class="btn" id="bookNowBtn">Quick Book</button>
          </div>
        </div>

        <div class="filters" id="filtersArea"></div>
        <div class="grid" id="gridArea"></div>
      </div>
    </div>

    <aside class="right">
      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px 0">Top Offers</h4>
        <div class="offers" id="offersArea"></div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px 0">Your Orders</h4>
        <div id="ordersArea" class="small">Login to view bookings</div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0">Account</h4>
        <div class="small" id="accountArea">Login to manage account</div>
      </div>
    </aside>
  </div>

</div>

<!-- City Modal -->
<div class="modal-backdrop" id="cityModal">
  <div class="modal">
    <h3>Select your city</h3>
    <p class="small">Choose a city to see local shows and venues.</p>
    <div id="cityGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:12px;max-height:50vh;overflow:auto"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" onclick="closeCityModal()">Close</button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div class="modal-backdrop" id="authModal">
  <div class="modal">
    <button class="small" style="float:right;background:transparent;border:0;color:var(--muted)" onclick="closeAuthModal()">✕</button>
    <h3 id="authTitle">Login</h3>
    <div id="authForm">
      <div class="form-row"><label>Email</label></div>
      <div class="form-row"><input id="authEmail" type="email" /></div>
      <div class="form-row"><label>Password</label></div>
      <div class="form-row"><input id="authPassword" type="password" /></div>
      <div class="form-row" style="margin-top:12px">
        <button class="btn" id="authSubmit">Submit</button>
        <button class="btn ghost" id="switchAuth">Switch to Sign up</button>
      </div>
      <div class="small" id="authMsg" style="margin-top:8px;color:#fda4a4"></div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal-backdrop" id="bookingModal">
  <div class="modal">
    <button class="small" style="float:right;background:transparent;border:0;color:var(--muted)" onclick="closeBookingModal()">✕</button>
    <h3 id="bookTitle">Book</h3>
    <div class="small" id="bookMeta"></div>
    <div style="margin-top:12px">
      <label>Select time</label>
      <div class="times" id="bookTimes"></div>
    </div>
    <div class="form-row"><label>Seats</label><input id="bookSeats" type="number" min="1" value="1" /></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closeBookingModal()">Cancel</button>
      <button class="btn" id="proceedToPay">Proceed to Pay</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal-backdrop" id="paymentModal">
  <div class="modal">
    <button class="small" style="float:right;background:transparent;border:0;color:var(--muted)" onclick="closePaymentModal()">✕</button>
    <h3>Payment</h3>
    <p class="small">This demo simulates payment (no real transactions).</p>
    <div style="margin-top:12px">
      <label>Method</label>
      <select id="payMethod">
        <option value="CARD">Card</option>
        <option value="UPI">UPI</option>
        <option value="NETBANKING">NetBanking</option>
      </select>
    </div>
    <div class="form-row" style="margin-top:12px"><label>Amount</label><input id="payAmount" type="number" readonly/></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closePaymentModal()">Cancel</button>
      <button class="btn" id="payNowBtn">Pay Now</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-backdrop" id="confirmModal">
  <div class="modal">
    <h3 id="confirmTitle">Confirm</h3>
    <p class="small" id="confirmText">Are you sure?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closeConfirm()">No</button>
      <button class="btn" id="confirmYes">Yes</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ============================================================
   Single-file BookMyShow Demo
   - All data in localStorage
   - Auth (signup/login/logout/delete/update)
   - City selector
   - Categories: movies, plays, sports, events, cinemas
   - Search, filters
   - Booking + simulated payment
   - Your Orders + cancellation
   ============================================================ */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const DB_KEY = 'bms_demo_v2';

function toast(msg, ms=3000){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }

// --- db helpers ---
function readDB(){ const raw = localStorage.getItem(DB_KEY); return raw ? JSON.parse(raw) : null; }
function writeDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function ensureDB(){
  let db = readDB();
  if(!db){
    db = {
      users: [], // {id,email,hash,name}
      sessions: null, // {userId}
      cities: seedCities(),
      offers: seedOffers(),
      items: seedItems(),
      bookings: [] // bookings
    };
    writeDB(db);
  }
  return db;
}
let DB = ensureDB();

// --- seed data ---
function seedCities(){
  return ["Mumbai","Delhi","Bengaluru","Hyderabad","Chennai","Kolkata","Pune","Ahmedabad","Jaipur","Surat","Lucknow","Kanpur","Nagpur","Visakhapatnam","Indore","Belagavi","Coimbatore","Madurai","Mysore","Vijayawada"];
}
function seedOffers(){
  return ["Flat ₹75 off with SBI cards","10% cashback via PhonePe","Buy 1 Get 1 on select shows","Student discount: 20%"];
}
function seedItems(){
  let id=1;
  const make = (category,title,lang,genre,desc,times,status,img)=> {
    return { id:id++, category, title, lang, genre, desc, times, status, img };
  };
  const movies = [
    make('movies','Pathaan','Hindi','Action','Spy thriller',['10:00 AM','1:00 PM','7:30 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/6/6e/Pathaan_film_poster.jpg'),
    make('movies','Avatar: The Way of Water','English','Sci-Fi','Epic science fiction',['12:00 PM','4:00 PM','9:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/f/f8/Avatar_The_Way_of_Water.jpg'),
    make('movies','Kantara','Kannada','Drama','Regional sensation',['11:30 AM','3:30 PM','8:30 PM'],'now-showing','https://stat5.bollywoodhungama.in/wp-content/uploads/2022/11/Kantara-to-premiere-on-Prime-Video-on-November-24-1-1.jpg'),
    make('movies','RRR','Telugu','Action','Epic period action',['10:30 AM','2:30 PM','7:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/f/f9/RRR_Poster.jpg'),
    make('movies','Oppenheimer','English','Drama','Biopic of Oppenheimer',['1:00 PM','5:00 PM'],'coming-soon','https://upload.wikimedia.org/wikipedia/en/0/0f/Oppenheimer_film_poster.jpg'),
    make('movies','KGF Chapter 2','Kannada','Thriller','High-octane thriller',['12:30 PM','6:30 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/c/c7/KGF_Chapter_2.jpg')
  ];
zz
  const plays = [
    make('plays','Hamlet','English','Tragedy','Shakespeare classic',['6:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/Hamlet_1600s.jpg/320px-Hamlet_1600s.jpg'),
    make('plays','Mughal-e-Azam','Hindi','Musical','Grandeur reimagined',['7:30 PM'],'coming-soon','https://upload.wikimedia.org/wikipedia/en/thumb/b/b1/Mughal-e-Azam_1957_film_poster.jpg/220px-Mughal-e-Azam_1957_film_poster.jpg'),
    make('plays','Macbeth','English','Tragedy','A dark tale',['6:30 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Macbeth_1606.jpg/220px-Macbeth_1606.jpg'),
    make('plays','The Lion King','English/Hindi','Musical','Family musical',['5:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/3/3d/The_Lion_King_2019_poster.jpg')
  ];

  const sports = [
    make('sports','India vs Australia','--','Cricket','ODI Series',['2:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Cricket_match_in_India.jpg/320px-Cricket_match_in_India.jpg'),
    make('sports','ISL Final','--','Football','League Final',['8:00 PM'],'coming-soon','https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/Football_match_2020.jpg/320px-Football_match_2020.jpg'),
    make('sports','WWE Live','--','Wrestling','High-energy show',['7:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/WWE_logo.svg/320px-WWE_logo.svg.png')
  ];

  const events = [
    make('events','Arijit Singh Live','--','Concert','Musical evening',['7:30 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/en/f/fb/Arijit_Singh.jpg'),
    make('events','Sunburn Festival','--','EDM','Electronic dance festival',['5:30 PM'],'coming-soon','https://upload.wikimedia.org/wikipedia/en/4/4a/Sunburn_India_Logo.jpg'),
    make('events','Comedy Night','--','Comedy','Stand-up special',['8:00 PM'],'now-showing','https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Standup_comedy.jpg/320px-Standup_comedy.jpg'),
    make('events','TEDx Bengaluru','--','Talks','Ideas worth spreading',['10:00 AM'],'coming-soon','https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/TEDx_logo.svg/320px-TEDx_logo.svg.png')
  ];

  const cinemas = [
    make('cinemas','PVR Cinemas - Phoenix','--','Multiplex','Luxury screens',[],'','https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/PVR_Cinemas_Logo.svg/320px-PVR_Cinemas_Logo.svg.png'),
    make('cinemas','INOX - Forum','--','Multiplex','Dolby Atmos',[],'','https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/INOX_Movies_logo.svg/320px-INOX_Movies_logo.svg.png'),
    make('cinemas','Cinepolis - Phoenix','--','Multiplex','Premium experience',[],'','https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Cinepolis_Logo.svg/320px-Cinepolis_Logo.svg.png')
  ];

  return { movies, plays, sports, events, cinemas };
}
// initial update
DB = ensureDB();
let STATE = {
  activeCategory: 'movies',
  filter: 'all',
  query: '',
  selectedCity: localStorage.getItem('bms_city') || null,
  authMode: 'login',
  currentBookingDraft: null
};

// DOM refs
const categoryTabs = $('#categoryTabs');
const filtersArea = $('#filtersArea');
const gridArea = $('#gridArea');
const offersArea = $('#offersArea');
const cityPill = $('#cityPill');
const cityNameEl = $('#cityName');
const authArea = $('#authArea');
const ordersArea = $('#ordersArea');
const accountArea = $('#accountArea');
const heroTitle = $('#heroTitle');
const heroSub = $('#heroSub');

// init UI
function init(){
  updateCityUI();
  renderCategoryTabs();
  renderOffers();
  renderFilters();
  renderGrid();
  renderAuthArea();
  renderOrdersArea();
  renderAccountArea();

  // handlers
  $('#searchBtn').onclick = ()=> { STATE.query = $('#searchInput').value.trim(); renderGrid(); };
  $('#searchInput').addEventListener('keyup', (e)=> { if(e.key==='Enter'){ STATE.query = $('#searchInput').value.trim(); renderGrid(); }});
  $('#cityPill').onclick = openCityModal;
  $('#loginBtn').onclick = ()=> openAuthModal('login');
  $('#signupBtn').onclick = ()=> openAuthModal('signup');
  $('#bookNowBtn').onclick = ()=> { const items = getItems(STATE.activeCategory); if(items.length) openBookingModal(items[0]); else toast('No items'); };

  // auth modal
  $('#authSubmit').onclick = submitAuth;
  $('#switchAuth').onclick = ()=> { STATE.authMode = STATE.authMode==='login' ? 'signup' : 'login'; updateAuthModal(); };
}
init();

// ----- helpers -----
function getDB(){ DB = ensureDB(); return DB; }
function getItems(cat){ const db = getDB(); return db.items[cat] || []; }
function findItem(cat,id){ return getItems(cat).find(x=>x.id===id); }
function currentUser(){ const db = getDB(); return db.sessions ? db.users.find(u=>u.id===db.sessions.userId) : null; }
function genId(prefix='BK'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

// --- UI renderers ---
function renderCategoryTabs(){
  const cats = ['movies','plays','sports','events','cinemas'];
  categoryTabs.innerHTML = '';
  cats.forEach(c=>{
    const b = document.createElement('button'); b.textContent = c[0].toUpperCase()+c.slice(1);
    b.onclick = ()=> { STATE.activeCategory=c; renderFilters(); renderGrid(); renderCategoryTabs(); };
    if(STATE.activeCategory===c) b.classList.add('active');
    categoryTabs.appendChild(b);
  });
}
function renderFilters(){
  filtersArea.innerHTML = '';
  ['all','now-showing','coming-soon'].forEach(f=>{
    const el = document.createElement('div'); el.className='chip'; el.textContent = f==='all'?'All':(f==='now-showing'?'Now Showing':'Coming Soon');
    el.onclick = ()=> { STATE.filter=f; renderGrid(); renderFilters(); };
    if(STATE.filter===f) el.classList.add('active');
    filtersArea.appendChild(el);
  });
}
function renderGrid(){
  heroTitle.textContent = STATE.activeCategory[0].toUpperCase()+STATE.activeCategory.slice(1);
  heroSub.textContent = `Explore ${STATE.activeCategory} in ${STATE.selectedCity || 'your city'}`;
  gridArea.innerHTML = '';
  const items = getItems(STATE.activeCategory).filter(it=>{
    if(STATE.filter==='now-showing' && it.status!=='now-showing') return false;
    if(STATE.filter==='coming-soon' && it.status!=='coming-soon') return false;
    if(STATE.query){
      const q = STATE.query.toLowerCase();
      return (it.title||'').toLowerCase().includes(q) || (it.genre||'').toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q) || (it.lang||'').toLowerCase().includes(q);
    }
    return true;
  });
  if(items.length===0){ gridArea.innerHTML = `<div class="small">No items found.</div>`; return; }
  items.forEach(it=>{
    const c = document.createElement('div'); c.className='card-item';
    c.innerHTML = `<div class="thumb" style="background-image:url('${it.img}')"></div>
      <div class="item-body">
        <div class="title">${it.title}</div>
        <div class="meta">${it.genre}${it.lang? ' · '+it.lang : ''}</div>
        <div class="desc">${it.desc}</div>
      </div>
      <div class="card-footer">
        <div class="small">${it.status || ''}</div>
        <div>
          <button class="btn ghost" onclick="viewDetails(${it.id},'${it.category}')">Details</button>
          <button class="btn" onclick="openBookingById(${it.id},'${it.category}')">Book</button>
        </div>
      </div>`;
    gridArea.appendChild(c);
  });
}
function renderOffers(){
  offersArea.innerHTML = '';
  getDB().offers.forEach(o=>{ const d=document.createElement('div'); d.className='offer'; d.textContent=o; offersArea.appendChild(d); });
}
function updateCityUI(){ cityNameEl.textContent = STATE.selectedCity || 'Select'; }
function renderAuthArea(){
  const user = currentUser();
  if(user){
    authArea.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
      <div class="small">Hi, ${user.name || user.email}</div>
      <button class="btn ghost" id="ordersBtn">Orders</button>
      <button class="btn ghost" id="accountBtn">Account</button>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>`;
    $('#logoutBtn').onclick = logout;
    $('#ordersBtn').onclick = ()=> window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    $('#accountBtn').onclick = openAccount;
  } else {
    authArea.innerHTML = `<button class="btn ghost" id="loginBtn">Login</button><button class="btn" id="signupBtn">Sign up</button>`;
    $('#loginBtn').onclick = ()=> openAuthModal('login');
    $('#signupBtn').onclick = ()=> openAuthModal('signup');
  }
}
function renderOrdersArea(){
  const user = currentUser(); ordersArea.innerHTML = '';
  if(!user){ ordersArea.innerHTML = '<div class="small">Login to view bookings</div>'; return; }
  const bookings = getDB().bookings.filter(b=>b.userId===user.id).sort((a,b)=>b.createdAt-a.createdAt);
  if(bookings.length===0){ ordersArea.innerHTML = '<div class="small">No bookings yet</div>'; return; }
  bookings.forEach(b=>{
    const it = findItem(b.category, b.itemId);
    const d = document.createElement('div'); d.style.borderBottom='1px solid rgba(255,255,255,0.02)'; d.style.padding='8px 0';
    d.innerHTML = `<div style="font-weight:700">${it?it.title:'Item'}</div>
      <div class="small">${b.category} · ${b.time} · ${b.seats} seats · ₹${b.amount}</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn ghost" onclick="viewBooking('${b.id}')">View</button>
        ${b.status==='CONFIRMED'?`<button class="btn" onclick="cancelBooking('${b.id}')">Cancel</button>`:`<div class="small">Status: ${b.status}</div>`}
      </div>`;
    ordersArea.appendChild(d);
  });
}
function renderAccountArea(){
  const user = currentUser();
  if(!user){ accountArea.innerHTML = 'Login to manage account'; return; }
  accountArea.innerHTML = `<div class="small">Name: ${user.name}</div><div class="small">Email: ${user.email}</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn ghost" onclick="openAccount()">Edit</button>
      <button class="btn" onclick="confirmDelete()">Delete</button>
    </div>`;
}

// --- City modal ---
function openCityModal(){
  const db = getDB();
  const cg = $('#cityGrid'); cg.innerHTML='';
  db.cities.forEach(city=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderRadius='8px'; div.style.cursor='pointer'; div.style.background='rgba(255,255,255,0.01)';
    div.textContent = city;
    div.onclick = ()=> { STATE.selectedCity = city; localStorage.setItem('bms_city', city); updateCityUI(); closeCityModal(); renderGrid(); };
    cg.appendChild(div);
  });
  $('#cityModal').style.display = 'flex';
}
function closeCityModal(){ $('#cityModal').style.display = 'none'; }

// --- Auth (simple hashing using SubtleCrypto) ---
async function hashStr(str){ const enc=new TextEncoder(); const data=enc.encode(str); const digest=await crypto.subtle.digest('SHA-256',data); return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function openAuthModal(mode='login'){ STATE.authMode=mode; updateAuthModal(); $('#authModal').style.display='flex'; }
function updateAuthModal(){ $('#authTitle').textContent = STATE.authMode==='login' ? 'Login' : 'Sign up'; $('#switchAuth').textContent = STATE.authMode==='login' ? 'Switch to Sign up' : 'Switch to Login'; $('#authMsg').textContent=''; $('#authEmail').value=''; $('#authPassword').value=''; }
function closeAuthModal(){ $('#authModal').style.display='none'; }
async function submitAuth(){
  const email = $('#authEmail').value.trim(); const pass = $('#authPassword').value;
  if(!email || !pass){ $('#authMsg').textContent='Email and password required'; return; }
  const db = getDB();
  if(STATE.authMode==='signup'){
    if(db.users.find(u=>u.email===email)){ $('#authMsg').textContent='Email already registered'; return; }
    const h=await hashStr(pass);
    const user={id:'U_'+Math.random().toString(36).slice(2,9),email,hash:h,name:email.split('@')[0]};
    db.users.push(user); db.sessions={userId:user.id}; writeDB(db); closeAuthModal(); renderAuthArea(); renderOrdersArea(); renderAccountArea(); toast('Signed up & logged in'); return;
  } else {
    const h=await hashStr(pass); const user = db.users.find(u=>u.email===email && u.hash===h);
    if(!user){ $('#authMsg').textContent='Invalid credentials'; return; }
    db.sessions={userId:user.id}; writeDB(db); closeAuthModal(); renderAuthArea(); renderOrdersArea(); renderAccountArea(); toast('Logged in'); return;
  }
}
function logout(){ const db=getDB(); db.sessions=null; writeDB(db); renderAuthArea(); renderOrdersArea(); renderAccountArea(); toast('Logged out'); }

// --- Booking flow ---
function openBookingById(id,cat){ const it=findItem(cat,id); if(!it) return toast('Item not found'); openBookingModal(it); }
function openBookingModal(item){
  STATE.currentBookingDraft={item,time:null,seats:1,amount:calcAmount(item)};
  $('#bookTitle').textContent = `Book — ${item.title}`;
  $('#bookMeta').textContent = `${item.genre || ''}${item.lang ? ' · '+item.lang : ''}`;
  const times=$('#bookTimes'); times.innerHTML='';
  (item.times||[]).forEach(t=>{ const b=document.createElement('div'); b.className='time'; b.textContent=t; b.onclick=()=>{ STATE.currentBookingDraft.time=t; times.querySelectorAll('.time').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }; times.appendChild(b); });
  $('#bookSeats').value=1; $('#bookSeats').oninput=()=> STATE.currentBookingDraft.seats=Math.max(1,parseInt($('#bookSeats').value||1));
  $('#proceedToPay').onclick = ()=> proceedToPayment();
  $('#bookingModal').style.display='flex';
}
function closeBookingModal(){ $('#bookingModal').style.display='none'; $('#proceedToPay').onclick = null; STATE.currentBookingDraft=null; }

function calcAmount(item){
  const base = { movies:180, plays:350, sports:700, events:500, cinemas:150 }[item.category] || 200;
  return base;
}

// --- Payment (simulate) ---
function proceedToPayment(){
  const user = currentUser(); if(!user){ closeBookingModal(); openAuthModal('login'); toast('Login required to book'); return; }
  const draft = STATE.currentBookingDraft; if(!draft.time){ toast('Select a showtime'); return; }
  $('#paymentModal').style.display='flex'; $('#payAmount').value = draft.amount * draft.seats; $('#payNowBtn').onclick = ()=> completePayment();
}
function closePaymentModal(){ $('#paymentModal').style.display='none'; $('#payNowBtn').onclick = null; }
function completePayment(){
  const db=getDB(), user=currentUser(), draft=STATE.currentBookingDraft;
  if(!user || !draft){ closePaymentModal(); return; }
  const booking = { id: genId('BK'), userId:user.id, itemId:draft.item.id, category:draft.item.category, time:draft.time, seats:draft.seats, amount:draft.amount * draft.seats, status:'CONFIRMED', createdAt:Date.now(), paymentMethod:$('#payMethod').value };
  db.bookings.push(booking); writeDB(db);
  closePaymentModal(); closeBookingModal(); renderOrdersArea(); toast('Payment successful — booking confirmed');
}

// --- Orders / cancel ---
function viewBooking(id){
  const db=getDB(), b=db.bookings.find(x=>x.id===id); if(!b) return toast('Not found');
  const it=findItem(b.category,b.itemId);
  $('#bookTitle').textContent = `Booking — ${it?it.title:'Item'}`; $('#bookMeta').textContent = `${b.time} · ${b.seats} seats · ₹${b.amount} · ${b.status}`;
  $('#bookTimes').innerHTML=''; $('#bookSeats').value=b.seats; $('#bookingModal').style.display='flex'; $('#proceedToPay').style.display='none';
}
function cancelBooking(id){
  if(!confirm('Cancel booking?')) return;
  const db=getDB(), b=db.bookings.find(x=>x.id===id); if(!b) return toast('Not found');
  if(b.status!=='CONFIRMED'){ toast('Cannot cancel'); return; }
  b.status='CANCELLED'; b.cancelledAt=Date.now(); writeDB(db); renderOrdersArea(); toast('Booking cancelled (demo)');
}

// --- Account edit / delete ---
function openAccount(){
  const user=currentUser(); if(!user) return openAuthModal('login');
  const newName = prompt('Update name', user.name || ''); if(newName===null) return;
  const db=getDB(); const u=db.users.find(x=>x.id===user.id); u.name=newName; writeDB(db); renderAccountArea(); renderAuthArea(); toast('Profile updated');
}
function confirmDelete(){
  if(!confirm('Delete account and all your bookings? This is irreversible.')) return;
  const user=currentUser(); if(!user) return;
  const db=getDB(); db.users = db.users.filter(u=>u.id!==user.id); db.bookings = db.bookings.filter(b=>b.userId!==user.id); db.sessions=null; writeDB(db);
  renderAuthArea(); renderOrdersArea(); renderAccountArea(); toast('Account deleted');
}

// --- Misc UI helpers ---
function viewDetails(id,cat){ const it=findItem(cat,id); if(!it) return toast('Not found'); openBookingModal(it); }
function openBookingById(id,cat){ openBookingById }
window.openBookingById = (id,cat)=> openBookingById(id,cat);
function openBookingById(id,cat){ const it=findItem(cat,id); if(it) openBookingModal(it); }

// --- Confirm modal helpers (not heavily used but available) ---
function openConfirm(text, onYes){
  $('#confirmText').textContent = text; $('#confirmYes').onclick = ()=>{ onYes(); closeConfirm(); }; $('#confirmModal').style.display='flex';
}
function closeConfirm(){ $('#confirmModal').style.display='none'; $('#confirmYes').onclick = null; }

// --- Modal close helpers exposed to HTML buttons ---
function closeAuthModal(){ $('#authModal').style.display='none'; }
function closeBookingModal(){ $('#bookingModal').style.display='none'; $('#proceedToPay').style.display='inline-block'; STATE.currentBookingDraft=null; }
function closePaymentModal(){ $('#paymentModal').style.display='none'; }
function closeCityModal(){ $('#cityModal').style.display='none'; }
function closeConfirm(){ $('#confirmModal').style.display='none'; }

// --- Initial render calls ---
updateCityUI();
renderCategoryTabs();
renderFilters();
renderOffers();
renderGrid();
renderAuthArea();
renderOrdersArea();
renderAccountArea();

</script>
</body>
</html>
